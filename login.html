<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Login</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .form-container {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      width: 340px;
    }

    h2 {
      text-align: center;
      margin-bottom: 1.2rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.3rem;
    }

    input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }

    .error {
      color: red;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    button {
      width: 100%;
      padding: 0.6rem;
      background: #5fa9ae;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover {
      background-color: #5fa9ae;
    }

    .message {
      margin-top: 1rem;
      text-align: center;
      font-size: 0.95rem;
      color: green;
    }
  </style>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">


</head>

<body>
  <div class="form-container">
    <h2 style="color: #5fa9ae;">Login</h2>
    <form id="auth-form" novalidate>
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" placeholder="Enter name" required />
        <div class="error" id="usernameError"></div>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <div style="position: relative;">
          <input type="password" id="password" name="password" placeholder="Enter password" minlength="8" required />
          <span id="togglePassword"
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
            <i class="bi bi-eye"></i>
          </span>
        </div>
        <div class="error" id="passwordError"></div>
      </div>


      <button type="submit" id="submit-btn">Login</button>

      <div class="message" id="message-box"></div>
    </form>
  </div>

  <div class="modal fade" id="updatePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <form id="updatePasswordForm">
          <input type="hidden" id="updatePasswordUserId">
          <div class="modal-body">
            <label for="newPassword">Enter new password:</label>
            <div class="form-group">
              <div style="position: relative;">
                <input type="password" id="newPassword" name="newPassword" placeholder="Enter password" minlength="8"
                  required />
                <span id="toggleNewPassword"
                  style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
                  <i class="bi bi-eye"></i>
                </span>
              </div>
              <div class="error" id="newPasswordError"></div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn" style="background: #5fa9ae;color: #fff;">Update Password</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1100">
    <div id="updatePasswordToast" class="toast align-items-center text-white bg-success border-0" role="alert"
      aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          Password updated successfully! Please login again.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>


  <script>

    // const BASE_URL = "https://api-beecroft.messagly.com";
    const BASE_URL = "http://localhost:5000";

    const authForm = document.getElementById("auth-form");
    const messageBox = document.getElementById("message-box");

    const usernameEl = document.getElementById("username");
    const passwordEl = document.getElementById("password");

    const usernameError = document.getElementById("usernameError");
    const passwordError = document.getElementById("passwordError");

    const passwordRegex = /^[A-Z][A-Za-z0-9]*[!@#$%^&*(),.?":{}|<>][A-Za-z0-9!@#$%^&*(),.?":{}|<>]{3,}$/;


    function clearErrors() {
      usernameError.textContent = "";
      passwordError.textContent = "";
    }

    // authForm.addEventListener("submit", async (e) => {
    //   e.preventDefault();
    //   clearErrors();
    //   let isValid = true;

    //   const username = usernameEl.value.trim();
    //   const password = passwordEl.value.trim();

    //   if (!username) {
    //     usernameError.textContent = "This field is required";
    //     isValid = false;
    //   }

    //   if (!password) {
    //     passwordError.textContent = "This field is required";
    //     isValid = false;
    //   }

    //   if (isValid) {
    //     if (!/^[A-Za-z\s]+$/.test(username)) {
    //       usernameError.textContent = "Name must contain only letters";
    //       isValid = false;
    //     }

    //     if (
    //       !/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/.test(password)
    //     ) {
    //       passwordError.textContent =
    //         "Password must be 8+ chars with upper, lower, digit & special char";
    //       isValid = false;
    //     }
    //   }

    //   if (!isValid) return;

    //   try {
    //     const response = await fetch(`${BASE_URL}/login`, {
    //       method: "POST",
    //       headers: {
    //         "Content-Type": "application/json",
    //       },
    //       credentials: "include",
    //       body: JSON.stringify({ username, password }),
    //     });

    //     const data = await response.json();

    //     if (response.ok) {
    //       authForm.reset();
    //       messageBox.textContent = data.message;
    //       window.location.href = "index.html";
    //     } else {
    //       messageBox.textContent = data.message || "Login failed";
    //     }
    //   } catch (err) {
    //     messageBox.textContent = "Server error";
    //   }
    // });

    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearErrors();
      let isValid = true;

      const username = usernameEl.value.trim();
      const password = passwordEl.value.trim();

      if (!username) {
        usernameError.textContent = "This field is required";
        isValid = false;
        setTimeout(() => {
          usernameError.textContent = ''
        }, 5000)
      }

      if (!password) {
        passwordError.textContent = 'This field is required'
        isValid = false
      }
     else if (!passwordRegex.test(password)) {
        e.preventDefault();
        passwordError.textContent = "Start with capital, 8+ chars, include number & symbol.";
      }
      else {
        passwordError.textContent = ""
      }


      if (!isValid) return;

      try {
        const response = await fetch(`${BASE_URL}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ username, password }),
        });

        const data = await response.json();

        if (response.ok) {
          if (data.firstLogin) {
            // Show modal to update password
            document.getElementById("updatePasswordUserId").value = data.userId;
            new bootstrap.Modal(document.getElementById("updatePasswordModal")).show();
          } else {
            authForm.reset();
            window.location.href = "index.html";
          }
        } else {
          messageBox.textContent = data.message || "Login failed";
          messageBox.style.color = "red";
          setTimeout(() => {
            messageBox.style.display = 'none'
          }, 5000)
        }
      } catch (err) {
        messageBox.textContent = "Server error";
        messageBox.style.color = "red";
        setTimeout(() => {
          messageBox.style.display = 'none'
        }, 5000)
      }
    });


    document.getElementById("updatePasswordForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const userId = document.getElementById("updatePasswordUserId").value;
      const newPassword = document.getElementById("newPassword").value.trim();
      const newPasswordError = document.getElementById("newPasswordError");

      if (!passwordRegex.test(newPassword)) {
        e.preventDefault(); // stop form submission
        newPasswordError.textContent = "Start with capital, 8+ chars, include number & symbol.";
        return;
      }
      else {
        newPasswordError.textContent = ""
      }


      try {
        const res = await fetch(`${BASE_URL}/api/update-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, newPassword }),
        });

        const data = await res.json();

        if (res.ok) {
          const toastEl = document.getElementById('updatePasswordToast');
          const toast = new bootstrap.Toast(toastEl);
          toast.show();

          // Optional: reload after toast shows
          setTimeout(() => {
            window.location.reload();
          }, 5000);
        } else {
          newPasswordError.textContent = data.message || "Password update failed";
        }
      } catch (err) {
        newPasswordError.textContent = "Server error";
      }
    });


    function setupPasswordToggle(toggleId, inputId) {
      document.getElementById(toggleId).addEventListener('click', function () {
        const input = document.getElementById(inputId);
        const icon = this.querySelector('i');
        const isPassword = input.getAttribute('type') === 'password';

        input.setAttribute('type', isPassword ? 'text' : 'password');
        icon.classList.toggle('bi-eye');
        icon.classList.toggle('bi-eye-slash');
      });
    }

    // Apply toggle to both fields
    setupPasswordToggle('togglePassword', 'password');
    setupPasswordToggle('toggleNewPassword', 'newPassword');





  </script>
</body>

</html>